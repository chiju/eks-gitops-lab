name: Helm Charts CI

on:
  pull_request:
    branches: [bootstrap]
    paths:
      - 'apps/**'
      - 'argocd-apps/**'
      - '.github/workflows/helm.yml'
  push:
    branches: [bootstrap]
    paths:
      - 'apps/**'
      - 'argocd-apps/**'

jobs:
  lint:
    name: Lint Helm Charts
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Helm
      uses: azure/setup-helm@v4
      with:
        version: 'v3.14.0'

    - name: Lint Charts
      run: |
        for chart in apps/*/; do
          if [ -f "$chart/Chart.yaml" ]; then
            echo "Linting $chart"
            helm lint "$chart"
          fi
        done

    - name: Template Charts
      run: |
        for chart in apps/*/; do
          if [ -f "$chart/Chart.yaml" ]; then
            echo "Templating $chart"
            helm template test "$chart" --debug
          fi
        done

  validate-argocd:
    name: Validate ArgoCD Apps
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Validate YAML
      run: |
        for file in argocd-apps/*.yaml; do
          echo "Validating $file"
          yamllint -d relaxed "$file" || true
        done
