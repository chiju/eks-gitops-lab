name: Update Karpenter Values from Terraform

on:
  workflow_dispatch:
  push:
    paths:
      - 'terraform/**'
    branches:
      - bootstrap

jobs:
  update-values:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-central-1
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false
      
      - name: Get Terraform Outputs
        id: terraform
        run: |
          cd terraform
          terraform init
          echo "cluster_name=$(terraform output -raw cluster_name)" >> $GITHUB_OUTPUT
          echo "cluster_endpoint=$(terraform output -raw cluster_endpoint)" >> $GITHUB_OUTPUT
          echo "karpenter_role_arn=$(terraform output -raw karpenter_controller_role_arn)" >> $GITHUB_OUTPUT
          echo "karpenter_node_role=$(terraform output -raw karpenter_node_role_name)" >> $GITHUB_OUTPUT
          echo "interruption_queue=$(terraform output -raw karpenter_sqs_queue_name)" >> $GITHUB_OUTPUT
      
      - name: Update Karpenter values.yaml
        run: |
          cat > apps/karpenter/values.yaml <<EOF
          # Auto-generated from Terraform outputs by GitHub Actions
          # Do not edit manually - changes will be overwritten
          
          karpenter:
            settings:
              clusterName: ${{ steps.terraform.outputs.cluster_name }}
              clusterEndpoint: ${{ steps.terraform.outputs.cluster_endpoint }}
              interruptionQueue: ${{ steps.terraform.outputs.interruption_queue }}
            
            serviceAccount:
              annotations:
                eks.amazonaws.com/role-arn: ${{ steps.terraform.outputs.karpenter_role_arn }}
          EOF
      
      - name: Update EC2NodeClass
        run: |
          cat > apps/karpenter/templates/ec2nodeclass.yaml <<EOF
          apiVersion: karpenter.k8s.aws/v1
          kind: EC2NodeClass
          metadata:
            name: default
          spec:
            role: ${{ steps.terraform.outputs.karpenter_node_role }}
            amiSelectorTerms:
              - alias: al2023@latest
            subnetSelectorTerms:
              - tags:
                  karpenter.sh/discovery: ${{ steps.terraform.outputs.cluster_name }}
            securityGroupSelectorTerms:
              - tags:
                  karpenter.sh/discovery: ${{ steps.terraform.outputs.cluster_name }}
          EOF
      
      - name: Commit and Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add apps/karpenter/values.yaml apps/karpenter/templates/ec2nodeclass.yaml
          git diff --staged --quiet || git commit -m "chore: Update Karpenter values from Terraform outputs [skip ci]"
          git push
